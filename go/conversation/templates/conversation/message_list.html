{% extends "app.html" %}
{% load conversation_tags %}

{% block content_extraclass %}conversations{% endblock %}

{% block content_title %}
  Messages for {{ conversation.name }}
{% endblock %}

{% block content_actions_left %}
  <button class="btn btn-primary" data-toggle="modal" data-target="#download-modal">Download</button>
{% endblock %}

{% block content_main %}

    <div class="row">
        <div class="col-md-3 sidebar" role="navigation">

            <ul class="nav nav-list">
                <li>
                    <a href="{% conversation_screen conversation 'message_list' %}" class="active">All messages</a>
                </li>
            </ul>

        </div>
        <div class="col-md-9">

            {% include "base/includes/messages.html" %}
                <ul class="nav nav-tabs">
                    <li {% ifequal message_direction 'inbound' %}class="active"{% endifequal %}>
                        <a href="?direction=inbound">
                            {{inbound_message_paginator.count}} Received
                        </a>
                    </li>
                    <li {% ifequal message_direction 'outbound' %}class="active"{% endifequal %}>
                        <a href="?direction=outbound">
                            {{outbound_message_paginator.count}} Sent
                        </a>
                    </li>
                    <li>
                        <a data-toggle="tab" href="#outbound-msg-stats">Statistics</a>
                    </li>
                </ul>

                <div class="tab-content" id="message-page">
                    <div class="tab-pane active">
                      <form class="table-form-view" method="post" action="">
                        {% if message_page.paginator.num_pages %}
                          {% include "conversation/message_list_table.html" %}
                        {% else %}
                          {% include "conversation/message_list_table_load.html" %}
                        {% endif %}
                      </form>
                    </div>
                    <div class="tab-pane" id="outbound-msg-stats">
                    <br/>

                    <div class="row">
                      <div class="col-md-offset-2 col-md-8">
                        <div class="alert alert-warning">Sorry, we're having trouble tracking message statistics at the moment, but we are working on it. That means the <strong>statistics might be out of date.</strong></div>

                          {% with conversation.get_progress_status as status %}

                          <div class="well">
                            <table class="table table-condensed">
                              <caption>
                                <h3>General statistics</h3>
                              </caption>

                              <tr>
                                <td>Number of contacts messages were received from</td>
                                <td>{{ inbound_uniques_count }}</td>
                              </tr>

                              <tr>
                                <td>Number of contacts messages were sent to</td>
                                <td>{{ outbound_uniques_count }}</td>
                              </tr>

                              <tr>
                                <td>Average messages received per minute</td>
                                <td>{{ conversation.get_inbound_throughput }}</td>
                              </tr>

                              <tr>
                                <td>Average messages sent per minute</td>
                                <td>{{ conversation.get_outbound_throughput }}</td>
                              </tr>
                            </table>
                          </div>

                          <div class="well">
                            <table class="table table-condensed">
                            <caption>
                              <h3>Send statistics</h3>
                            </caption>
                            <thead>
                              <th></th><th>Count</th><th>Percentage</th>
                            </thead>
                            <tbody>
                              <tr>
                                <th>Total&nbsp;sent</th><td colspan="2">{{ status.sent }}</td>
                              </tr>
                              <tr class="info">
                                <td colspan="3">Accepted by aggregator, MNO or other third-party for sending:</td>
                              </tr>
                              <tr>
                                <th>Accepted</th><td>{{ status.ack }}</td>
                                <td>{% percentage status.ack status.sent %}%</td>
                              </tr>
                              <tr>
                                <th>Rejected</th><td>{{ status.nack}}</td>
                                <td>{% percentage status.nack status.sent %}%</td>
                              </tr>
                              <tr class="info">
                                <td colspan="3">Delivery reports:</td>
                              </tr>
                              <tr>
                                <th>Delivered</th><td>{{ status.delivery_report_delivered }}</td>
                                <td>{% percentage status.delivery_report_delivered status.sent %}%</td>
                              </tr>
                              <tr>
                                <th>Pending</th><td>{{ status.delivery_report_pending }}</td>
                                <td>{% percentage status.delivery_report_pending status.sent %}%</td>
                              </tr>
                              <tr>
                                <th>Failed</th><td>{{ status.delivery_report_failed }}</td>
                                <td>{% percentage status.delivery_report_failed status.sent %}%</td>
                              </tr>
                            </tbody>
                            </table>
                            <p>Note: not all channels support delivery reports.</p>
                          </div>
                        </div>
                      {% endwith %}
                    </div>

                </div>
              </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
<div class="modal fade" id="download-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">Ã—</a>
                <h3>Download messages for {{ conversation.name }}</h3>
            </div>

            <div class="modal-body">
              <form>

                <div class="form-group">
                  <label>Format</label>
                  <br/>

                  <div class="btn-group" data-toggle="buttons">
                    <label class="btn btn-default active">
                      <input class="form-control" type="radio" autocomplete="off" checked>CSV
                    </label>
                    <label class="btn btn-default">
                      <input class="form-control" type="radio" autocomplete="off">JSON
                    </label>
                  </div>
                </div>

                <div class="form-group">
                  <label>Message direction</label>
                  <br/>

                  <div class="btn-group" data-toggle="buttons">
                    <label class="btn btn-default active">
                      <input type="radio" autocomplete="off" checked>Received messages
                    </label>
                    <label class="btn btn-default">
                      <input type="radio" autocomplete="off">Sent messages
                    </label>
                  </div>
                </div>

                <div class="form-group">
                  <label>Date range</label>
                  <br/>

                  <div class="list-group list-group-select date-range-presets">
                    <a class="list-group-item active" href="#">All messages</a>
                    <a class="list-group-item" href="#">Today</a>
                    <a class="list-group-item" href="#">Last 7 days</a>
                    <a class="list-group-item" href="#">Last 30 days</a>
                    <div class="list-group-item hidden"></div>
                  </div>

                  <a class="list-group-item date-range-custom-toggle" data-toggle="collapse" href="#date-range-custom-picker" style="margin-top:-20px; border-top: none; border-radius: 4px;">
                    Custom range
                    <span class="pull-right glyphicon glyphicon-chevron-down"></span>
                  </a>

                  <div class="well collapse" id="date-range-custom-picker">
                    <div class="input-daterange input-group" data-provide="datepicker" data-date-format="dd/mm/yyyy">
                      <input type="text" class="input-sm form-control" name="start">
                      <span class="input-group-addon">to</span>
                      <input type="text" class="input-sm form-control" name="end">
                    </div>
                  </div>
                </div>

                <button class="btn btn-primary" type="button" data-dismiss="modal">Download</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block ondomready %}
$('.date-range-presets .list-group-item').click(function() {
  $('.date-range-presets')
    .find('.list-group-item')
    .removeClass('active');

  $(this).addClass('active');

  if ($('#date-range-custom-picker.in').length) {
    $('#date-range-custom-picker').collapse('hide');

    $('.date-range-custom-toggle')
      .find('.glyphicon')
      .toggleClass('glyphicon-chevron-down')
      .toggleClass('glyphicon-chevron-up');
  }

  $('.date-range-custom-toggle').removeClass('active').css('border-radius', '4px');
});

$('.date-range-custom-toggle').click(function() {
  $('.date-range-custom-toggle')
    .toggleClass('active')
    .css('border-radius', 0);

  $('.date-range-custom-toggle')
    .find('.glyphicon')
    .toggleClass('glyphicon-chevron-down')
    .toggleClass('glyphicon-chevron-up');

  if ('.date-range-custom-toggle.active')
    $('.date-range-presets')
      .find('.list-group-item')
      .removeClass('active');
});
{% endblock %}
